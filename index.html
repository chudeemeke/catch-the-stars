<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="theme-color" content="#2e3350" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="assets/icon-192.png">
<title>Catch the Stars ‚Äî Stealth Learning</title>
<style>
  :root{
    --bg1:#2e3350; --bg2:#1c1f33; --accent:#ffd166; --good:#06d6a0; --bad:#ef476f; --ink:#ffffff;
  }
  html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:radial-gradient(120vw 120vh at 50% 70%, var(--bg1), var(--bg2));color:var(--ink);}
  canvas{display:block;touch-action:none;}
  .hud{position:fixed; left:0; right:0; top:0; display:flex; align-items:center; gap:.75rem; padding:.6rem .8rem; background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0)); user-select:none; -webkit-user-select:none;}
  .hud .chip{background:rgba(255,255,255,.12); padding:.35rem .6rem; border-radius:.7rem; font-weight:700; font-size:14px; letter-spacing:.2px}
  .hud .title{font-weight:800; font-size:16px; margin-right:auto; display:flex; gap:.5rem; align-items:center}
  .hud .btn{cursor:pointer; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25); padding:.45rem .7rem; border-radius:.6rem; font-weight:700;}
  .prompt{position:fixed; left:50%; transform:translateX(-50%); top:48px; padding:.5rem 1rem; border-radius:.8rem; background:rgba(0,0,0,.35); backdrop-filter: blur(6px); font-weight:800; letter-spacing:.3px; box-shadow:0 6px 18px rgba(0,0,0,.25);}
  .footer{position:fixed; left:0; right:0; bottom:0; display:flex; justify-content:center; gap:.5rem; padding:10px; background:linear-gradient(to top, rgba(0,0,0,.35), rgba(0,0,0,0));}
  .pill{padding:.4rem .7rem; border-radius:999px; background:rgba(255,255,255,.12); font-size:13px; font-weight:700}
  .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(3,6,23,.55); backdrop-filter: blur(8px);}
  .overlay.show{display:grid;}
  .panel{width:min(680px, 92vw); max-height:86vh; overflow:auto; background:rgba(20,22,40,.95); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .panel h2{margin:.2rem 0 1rem 0}
  .row{display:flex; flex-wrap:wrap; gap:.5rem; margin:.4rem 0}
  .row .toggle{display:flex; align-items:center; gap:.5rem; padding:.5rem .7rem; background:rgba(255,255,255,.08); border-radius:10px; cursor:pointer;}
  .row input[type="checkbox"]{transform:scale(1.2)}
  .panel .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:.5rem}
  .panel .btn{cursor:pointer; background:var(--accent); color:#1a1725; border:none; font-weight:900; padding:.7rem 1rem; border-radius:10px; margin-top:8px}
  .center{display:flex; justify-content:center; align-items:center; gap:.5rem}
  .big{font-size:20px}
  .heart{color:var(--bad)}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .hint{position:fixed; right:10px; top:10px; font-size:12px; opacity:.75}
  #installBanner{position:fixed; left:0; right:0; bottom:0; display:none; gap:.6rem; justify-content:center; align-items:center; background:rgba(0,0,0,.6); padding:10px; color:#fff;}
  #installBanner button{font-weight:800; border:none; border-radius:10px; padding:.5rem .8rem; background:#ffd166; color:#1a1725; cursor:pointer;}
</style>
</head>
<body>
  <div class="hud">
    <div class="title">üåü Catch the Stars</div>
    <div class="chip" id="scoreChip">Score: 0</div>
    <div class="chip" id="streakChip">Streak: 0</div>
    <div class="chip" id="levelChip">Level: 1</div>
    <div class="chip" id="livesChip">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div class="btn" id="btnPause" aria-label="Pause">‚è∏</div>
    <div class="btn" id="btnSettings" aria-label="Settings">‚öôÔ∏è</div>
  </div>
  <div class="prompt" id="prompt">Tap the right star!</div>
  <div class="footer">
    <div class="pill" id="modePill">Modes: Numbers ‚Ä¢ Letters ‚Ä¢ Colors ‚Ä¢ +/‚àí</div>
  </div>
  <div class="hint" aria-hidden="true">Tip: you can tap with multiple fingers!</div>
  <div id="installBanner" role="dialog" aria-live="polite">
    <span>Add to Home Screen?</span>
    <button id="btnInstall">Install</button>
  </div>

  <canvas id="game"></canvas>

  <!-- Pause Menu -->
  <div class="overlay" id="pauseOverlay" role="dialog" aria-modal="true" aria-labelledby="pauseTitle">
    <div class="panel">
      <h2 id="pauseTitle">Paused</h2>
      <div class="row">
        <button class="btn" id="btnResume">Resume ‚ñ∂</button>
        <button class="btn" id="btnRestart">Restart ‚Ü∫</button>
      </div>
      <p>Goal: pop the star(s) that match the prompt. Win rounds to level up. Misses cost hearts.</p>
    </div>
  </div>

  <!-- Settings -->
  <div class="overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="panel">
      <h2 id="settingsTitle">Settings</h2>
      <div class="grid">
        <label class="toggle"><input type="checkbox" id="modeNumbers" checked> Numbers (0‚Äì20)</label>
        <label class="toggle"><input type="checkbox" id="modeLetters" checked> Letters (A‚ÄìZ)</label>
        <label class="toggle"><input type="checkbox" id="modeColors" checked> Colors (names)</label>
        <label class="toggle"><input type="checkbox" id="modeAddSub" checked> Math (+/‚àí ‚â§ 10)</label>
        <label class="toggle"><input type="checkbox" id="modeShapes"> Shapes (‚ñ≤ ‚óè ‚ñ†)</label>
        <label class="toggle"><input type="checkbox" id="soundOn" checked> Sound</label>
      </div>
      <div class="row">
        <label class="toggle">Target per round:
          <select id="targetsPerRound">
            <option>1</option><option>2</option><option selected>3</option><option>4</option>
          </select>
        </label>
        <label class="toggle">Round length (sec):
          <select id="roundSeconds">
            <option>20</option><option selected>30</option><option>45</option>
          </select>
        </label>
        <label class="toggle">Difficulty:
          <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button class="btn" id="btnApply">Apply & Close</button>
      </div>
      <p style="opacity:.8">Pro tip: toggle modes to shape the kind of learning you want today.</p>
    </div>
  </div>

<script>
// --- PWA Install Prompt ---
let deferredPrompt = null;
const banner = document.getElementById('installBanner');
const btnInstall = document.getElementById('btnInstall');
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  banner.style.display = 'flex';
});
btnInstall?.addEventListener('click', async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  banner.style.display = 'none';
  deferredPrompt = null;
});
// Register Service Worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>

<!-- Game Code (same as shipped previously, trimmed only for head housekeeping) -->
<script>
const rand=(min,max)=>Math.random()*(max-min)+min;
const choice=arr=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const COLORS=["red","blue","green","yellow","purple","orange","pink","brown","gray","black","white"];
const COLOR_TO_HEX={red:"#ef476f",blue:"#118ab2",green:"#06d6a0",yellow:"#ffd166",purple:"#7e57c2",orange:"#f77f00",pink:"#ff76b8",brown:"#8d6e63",gray:"#9e9e9e",black:"#111",white:"#fff"};
let audioCtx=null;
function beep(type="good"){
  const soundEnabled=document.getElementById("soundOn")?.checked??true;
  if(!soundEnabled) return;
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type="sine"; o.frequency.value=(type==="good")?880:220; g.gain.value=0.001;
  o.connect(g); g.connect(audioCtx.destination);
  const now=audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.08, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
  o.start(); o.stop(now+0.2);
}
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d",{alpha:true});
let W=window.innerWidth,H=window.innerHeight;
function resize(){W=window.innerWidth;H=window.innerHeight;canvas.width=W;canvas.height=H}
resize(); window.addEventListener("resize",resize,{passive:true});
const HUD={scoreEl:document.getElementById("scoreChip"),streakEl:document.getElementById("streakChip"),levelEl:document.getElementById("levelChip"),livesEl:document.getElementById("livesChip"),promptEl:document.getElementById("prompt"),modePill:document.getElementById("modePill"),
  setScore(v){this.scoreEl.textContent=`Score: ${v}`}, setStreak(v){this.streakEl.textContent=`Streak: ${v}`}, setLevel(v){this.levelEl.textContent=`Level: ${v}`}, setLives(n){this.livesEl.textContent="‚ù§Ô∏è".repeat(n)}, setPrompt(t){this.promptEl.textContent=t}, setModePill(t){this.modePill.textContent=`Modes: ${t}`} };
const Modes={numbers:true,letters:true,colors:true,addsub:true,shapes:false};
let game={running:true,score:0,streak:0,level:1,lives:3,roundTime:30,targetsPerRound:3,timeLeft:30,stars:[],roundActive:false,difficulty:"normal",prompt:null,correctTag:null};
function generatePrompt(){
  const enabled=[]; if(Modes.numbers) enabled.push("numbers"); if(Modes.letters) enabled.push("letters"); if(Modes.colors) enabled.push("colors"); if(Modes.addsub) enabled.push("addsub"); if(Modes.shapes) enabled.push("shapes");
  const type=choice(enabled); let text,tag,renderStyle=null;
  switch(type){
    case "numbers":{const n=Math.floor(rand(0,21)); text=`Find the number: ${n}`; tag=`num:${n}`; renderStyle={fill:"#fff",stroke:"#000"}; break;}
    case "letters":{const code=Math.floor(rand(65,91)); const ch=String.fromCharCode(code); text=`Find the letter: ${ch}`; tag=`let:${ch}`; renderStyle={fill:"#fff",stroke:"#000"}; break;}
    case "colors":{const c=choice(COLORS); text=`Find the color: ${c}`; tag=`col:${c}`; renderStyle={fill:COLOR_TO_HEX[c]||"#fff",stroke:"#000",hollow:true}; break;}
    case "addsub":{const a=Math.floor(rand(0,11)); const b=Math.floor(rand(0,11)); const sign=(Math.random()<0.5)?"+":"-"; const res=sign==="+"?a+b:a-b; if(res<0||res>10) return generatePrompt(); text=`Solve: ${a} ${sign} ${b}`; tag=`num:${res}`; renderStyle={fill:"#fff",stroke:"#000"}; break;}
    case "shapes":{const shapes=["‚óè","‚ñ≤","‚ñ†"]; const s=choice(shapes); text=`Find the shape: ${s}`; tag=`shp:${s}`; renderStyle={fill:"#fff",stroke:"#000"}; break;}
  }
  return {type,text,tag,renderStyle};
}
class Star{
  constructor(x,y,opts){
    this.x=x??rand(60,W-60); this.y=y??rand(120,H-120); this.r=rand(28,45);
    const baseSpeed={easy:1.1,normal:1.6,hard:2.2}[game.difficulty]+(game.level-1)*0.15;
    this.vx=rand(-baseSpeed,baseSpeed); this.vy=rand(-baseSpeed,baseSpeed);
    this.color=`hsl(${Math.floor(rand(0,360))},80%,60%)`; this.life=rand(9,14);
    this.label=opts?.label??""; this.tag=opts?.tag??null; this.correct=!!opts?.correct; this.renderStyle=opts?.renderStyle||null; this.shape=opts?.shape||null;
  }
  update(dt){ this.x+=this.vx*dt*60; this.y+=this.vy*dt*60; if(this.x<this.r||this.x>W-this.r) this.vx*=-1; if(this.y<this.r||this.y>H-this.r) this.vy*=-1; this.life-=dt; }
  draw(ctx){
    const g=ctx.createRadialGradient(this.x,this.y,this.r*0.2,this.x,this.y,this.r*1.2);
    g.addColorStop(0,"rgba(255,255,255,.6)"); g.addColorStop(1,"rgba(255,255,255,0)"); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(this.x,this.y,this.r*1.3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle=this.color; ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill();
    if(this.renderStyle?.hollow){ ctx.beginPath(); ctx.arc(this.x,this.y,this.r*0.86,0,Math.PI*2); ctx.fillStyle=this.renderStyle.fill; ctx.fill(); }
    ctx.fillStyle=(this.renderStyle?.fill)||"#fff"; ctx.strokeStyle=(this.renderStyle?.stroke)||"rgba(0,0,0,.35)"; ctx.lineWidth=3; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font=`${Math.floor(this.r*0.9)}px/1.1 ui-rounded, system-ui, sans-serif`;
    if(this.shape){ ctx.strokeText(this.shape,this.x,this.y); ctx.fillText(this.shape,this.x,this.y);} else if(this.label){ ctx.strokeText(this.label,this.x,this.y); ctx.fillText(this.label,this.x,this.y); }
    if(this.correct){ ctx.beginPath(); ctx.lineWidth=4; ctx.strokeStyle="rgba(255,255,255,.7)"; ctx.arc(this.x,this.y,this.r+6*Math.sin(perf*3+this.x*0.01),0,Math.PI*2); ctx.stroke(); }
  }
}
function spawnRound(){
  game.stars.length=0;
  const prompt=generatePrompt(); game.prompt=prompt; game.correctTag=prompt.tag; HUD.setPrompt(prompt.text);
  const slots=Math.max(6,4+game.level); const indices=Array.from({length:slots},(_,i)=>i); const correctSlots=[];
  while(correctSlots.length<game.targetsPerRound){ const pick=indices.splice(Math.floor(Math.random()*indices.length),1)[0]; correctSlots.push(pick); }
  for(let i=0;i<slots;i++){
    let opts={renderStyle:prompt.renderStyle}; let label="", tag="";
    switch(prompt.type){
      case "numbers":{const val=(correctSlots.includes(i))?parseInt(prompt.tag.split(":")[1]):Math.floor(rand(0,21)); label=String(val); tag=`num:${val}`; break;}
      case "letters":{const alph="ABCDEFGHIJKLMNOPQRSTUVWXYZ"; const val=(correctSlots.includes(i))?prompt.tag.split(":")[1]:alph[Math.floor(rand(0,26))]; label=val; tag=`let:${val}`; break;}
      case "colors":{const val=(correctSlots.includes(i))?prompt.tag.split(":")[1]:choice(COLORS); label=""; tag=`col:${val}`; opts.renderStyle={fill:COLOR_TO_HEX[val]||"#fff",stroke:"#000",hollow:true}; break;}
      case "addsub":{const val=(correctSlots.includes(i))?parseInt(prompt.tag.split(":")[1]):Math.floor(rand(0,11)); label=String(val); tag=`num:${val}`; break;}
      case "shapes":{const shapes=["‚óè","‚ñ≤","‚ñ†"]; const val=(correctSlots.includes(i))?prompt.tag.split(":")[1]:choice(shapes); label=""; tag=`shp:${val}`; opts.shape=val; break;}
    }
    opts.label=label; opts.tag=tag; opts.correct=(tag===prompt.tag); game.stars.push(new Star(undefined,undefined,opts));
  }
  game.timeLeft=game.roundTime; game.roundActive=true;
}
function endRound(win){
  game.roundActive=false; game.stars.length=0;
  if(win){ game.level++; game.score+=10+2*game.streak; game.streak++; beep("good"); }
  else { game.lives--; game.streak=0; beep("bad"); }
  HUD.setScore(game.score); HUD.setStreak(game.streak); HUD.setLevel(game.level); HUD.setLives(game.lives);
  if(game.lives<=0){ showPause(true,"Game Over üí•"); return; }
  setTimeout(spawnRound,800);
}
function handleTap(x,y){
  if(!game.roundActive) return;
  let hitCorrect=0, hitWrong=0;
  for(let i=game.stars.length-1;i>=0;i--){
    const s=game.stars[i]; const d=Math.hypot(s.x-x,s.y-y);
    if(d<s.r){
      if(s.correct){ game.score+=2; hitCorrect++; game.stars.splice(i,1); beep("good"); }
      else { hitWrong++; game.score=Math.max(0,game.score-1); beep("bad"); }
    }
  }
  HUD.setScore(game.score);
  const anyCorrectLeft=game.stars.some(s=>s.correct);
  if(hitCorrect>0 && !anyCorrectLeft) endRound(true);
  if(hitWrong>0 && hitCorrect===0){
    game.lives=Math.max(0,game.lives-1); HUD.setLives(game.lives);
    if(game.lives<=0){ endRound(false); }
  }
}
canvas.addEventListener("touchstart",e=>{ for(const t of e.changedTouches){ handleTap(t.clientX,t.clientY); } },{passive:true});
canvas.addEventListener("pointerdown",e=>{ handleTap(e.clientX,e.clientY); });
let last=0, perf=0;
function loop(ts){
  if(!last) last=ts; const dt=clamp((ts-last)/1000,0,0.05); last=ts; perf=ts/1000;
  if(game.running){
    if(game.roundActive){
      for(const s of game.stars) s.update(dt);
      game.stars=game.stars.filter(s=>s.life>0);
      game.timeLeft-=dt;
      const anyCorrect=game.stars.some(s=>s.correct);
      if(!anyCorrect) endRound(true);
      else if(game.timeLeft<=0) endRound(false);
    }
    ctx.clearRect(0,0,W,H);
    ctx.save();
    for(let i=0;i<50;i++){ const x=(i*37%W); const y=(i*83%H); const r=(i%7)/7*2+0.3; ctx.fillStyle="rgba(255,255,255,.15)"; ctx.beginPath(); ctx.arc((x+perf*20)%W,(y+perf*10)%H,r,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
    for(const s of game.stars) s.draw(ctx);
    if(game.roundActive){
      const pct=clamp(game.timeLeft/game.roundTime,0,1); const radius=26; const cx=W-42, cy=42;
      ctx.beginPath(); ctx.strokeStyle="rgba(255,255,255,.35)"; ctx.lineWidth=6; ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.strokeStyle="rgba(255,255,255,.9)"; ctx.lineWidth=6; ctx.arc(cx,cy,radius,-Math.PI/2,-Math.PI/2+Math.PI*2*pct); ctx.stroke();
    }
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
const pauseOverlay=document.getElementById("pauseOverlay"); const settingsOverlay=document.getElementById("settingsOverlay");
const btnPause=document.getElementById("btnPause"); const btnResume=document.getElementById("btnResume"); const btnRestart=document.getElementById("btnRestart"); const btnSettings=document.getElementById("btnSettings"); const btnApply=document.getElementById("btnApply");
function showPause(force=false,titleText=null){
  pauseOverlay.classList.add("show");
  pauseOverlay.querySelector("h2").textContent = titleText?titleText:"Paused";
  game.running=false;
}
function hidePause(){ pauseOverlay.classList.remove("show"); game.running=true; if(audioCtx&&audioCtx.state==="suspended"){ audioCtx.resume().catch(()=>{});} }
btnPause.addEventListener("click",()=>showPause()); btnResume.addEventListener("click",hidePause);
btnRestart?.addEventListener("click",()=>{ game.score=0; game.streak=0; game.level=1; game.lives=3; HUD.setScore(0); HUD.setStreak(0); HUD.setLevel(1); HUD.setLives(3); spawnRound(); hidePause(); });
btnSettings.addEventListener("click",()=>{
  document.getElementById("modeNumbers").checked=Modes.numbers;
  document.getElementById("modeLetters").checked=Modes.letters;
  document.getElementById("modeColors").checked=Modes.colors;
  document.getElementById("modeAddSub").checked=Modes.addsub;
  document.getElementById("modeShapes").checked=Modes.shapes;
  document.getElementById("targetsPerRound").value=String(game.targetsPerRound);
  document.getElementById("roundSeconds").value=String(game.roundTime);
  document.getElementById("difficulty").value=game.difficulty;
  settingsOverlay.classList.add("show"); game.running=false;
});
btnApply.addEventListener("click",()=>{
  Modes.numbers=document.getElementById("modeNumbers").checked;
  Modes.letters=document.getElementById("modeLetters").checked;
  Modes.colors=document.getElementById("modeColors").checked;
  Modes.addsub=document.getElementById("modeAddSub").checked;
  Modes.shapes=document.getElementById("modeShapes").checked;
  game.targetsPerRound=parseInt(document.getElementById("targetsPerRound").value,10);
  game.roundTime=parseInt(document.getElementById("roundSeconds").value,10);
  game.difficulty=document.getElementById("difficulty").value;
  const activeList=Object.entries(Modes).filter(([k,v])=>v).map(([k])=>({numbers:"Numbers",letters:"Letters",colors:"Colors",addsub:"+/‚àí",shapes:"Shapes"}[k]));
  HUD.setModePill(`Modes: ${activeList.join(" ‚Ä¢ ") || "None (toggle some!)"}`);
  settingsOverlay.classList.remove("show"); game.running=true; if(!game.roundActive) spawnRound();
});
[pauseOverlay,settingsOverlay].forEach(ov=>{ ov.addEventListener("click",(e)=>{ if(e.target===ov){ ov.classList.remove("show"); game.running=true; } }); });
function boot(){ HUD.setScore(0); HUD.setStreak(0); HUD.setLevel(1); HUD.setLives(3);
  const activeList=Object.entries(Modes).filter(([k,v])=>v).map(([k])=>({numbers:"Numbers",letters:"Letters",colors:"Colors",addsub:"+/‚àí",shapes:"Shapes"}[k]));
  HUD.setModePill(`Modes: ${activeList.join(" ‚Ä¢ ")}`); spawnRound();
}
boot();
</script>
</body>
</html>
